# Readme placeholder

Сервис для получения актуального курса usdt/rub и хранения истории его изменения.  
Помимо основы сервиса - элемента App, docker-compose также включает Prometheus, Jaeger и Postgres, которые могут быть заменены на внешние зависимости, при необходимости.  

# Запуск

Для запуска приложения требуется Docker с поддержкой docker-compose.  

Быстрый запуск:
```
$ git clone https://studentgit.kata.academy/Rodion/go-usd-tracker.git/
$ cd go-usd-tracker
$ docker-compose up -d
$ docker-compose run --rm --service-ports app ./app -default
```

Запуск сервиса, если локальная копия репозитория уже существует (из корневого каталога локального репозитория):  
```
$ docker-compose up -d
$ docker-compose run --rm --service-ports app ./app -default
```

Для завершения работы сервиса:
```
$ docker-compose down --volumes
```

# Endpoints

service:8080 - gRPC сервер, спецификация: /go-usd-tracker/pkg/grpc/service.proto  
service:8081 - HTTP сервер, маршруты:  
    GET /swagger - интерактивная документация к http endpointa'м сервиса  
    GET /healthy - используется для проверки работоспособности сервера, например при помощи "curl -f http://localhost:8081/healthy"  
    GET /rates - получение текущего курса usdt/rub  
    GET /metrics - метрики сервиса в формате prometheus  
    
# Параметры запуска

Параметры запуска приложения могут быть настроены при помощи .env файла в корне, либо переданы при запуске через командную строку в формате -{name}={value}, например:  
```
$ docker-compose run --rm --service-ports app ./app -llevel=INFO
```

При запуске сервиса без параметров, gRPC и HTTP серверы запущены не будут, вместо этого в консоль будут выведены доступные параметры запуска, и работа сервиса будет завершена.  
Для запуска без параметров командной строки следует использовать флаг -default: будут применены только параметры из .env файла, либо параметры по умолчанию.  
В случае, если один параметр запуска задан в нескольких источниках, приоритет использования следующий: параметр командной строки > значение из .env файла > переменная окружения.

| Переменная окружения | CL флаг     | По умолчанию | Описание |
|----------------------|-------------|--------------|----------|
| POSTGRES_CONN | -dbconn || Строка подулючения к БД |
| MIGRATIONS_URL | -dbmigurl | "file:///goserver/internal/repository/db/migrations/" | Путь к файлам миграций БД |
| INTEGRATION_TESTS_DB_CONN | - || Строка подключения к БД для интеграционных тестов |
| AUTO_MIGRATE_UP | -amigup | true | Признак автоматического запуска миграций БД вверх |
| AUTO_MIGRATE_DOWN | -amigdown | false | Признак автоматического запуска миграций БД вниз |
| DB_PASSWORD | - || Пароль к БД |
| DB_USER     | - || Пользователь БД |
| DB_NAME     | - || Имя БД |
| DB_PORT     | - || Порт БД |
| DB_HOST     | - || Адрес БД |
|             |             |              |          |
| GRPC_SERVER | -grpcaddr |"0.0.0.0:8080"| Адрес gRPC сервера сервиса |
| HTTP_SERVER | -httpaddr |"0.0.0.0:8081"| Адрес HTTP сервера сервиса |
|             |             |              |          |
| LOG_LEVEL   | -llevel | "DEBUG" | Уровень логирования |
| LOG_TO_JSON | -ljson | "false" | Записывать логи в машиночитаемом json формате |
| LOG_EXTENDED  | -lext | "false" | Определяет выбор предустановки для логера: Production (true), Development (false) |
| LOG_TO_FILE   | - | "false" | Необходимость логирования в файл, принимает значение "true", если параметр CL -lfile не пуст |
| LOG_FILE      | -lfile | "" | Путь к лог-файлу, может содержать маркер %s для метки времени |
| LOG_FILE_TIME_FORMAT | -ltimeformat | "2006-01-02" | формат метки времени в имени файла |
| LOG_FILE_LIFETIME | -llifetime | 84600 | Период переоткрытия лог-файла (в секундах) |

# Трассировка

Трассировка работы сервиса производится при помощи библиотеки OpenTelemetry, данные экспортируются в Jaeger при помощи gRPC. Jaeger UI сервиса доступен по service:16686. При необходимости, экспорт может быть перенаправлен путем изменения переменной окружения OTEL_EXPORTER_OTLP_ENDPOINT.

# Метрики

Метрики сервиса экспортируются в формате prometheus, доступны по service:8081/metrics, UI prometheus доступен по service:9090.

# Логирование

Логирование производится при помощи библиотеки Zap. Параметры логирования описаны выше.




